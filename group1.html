<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公式リファレンス - 内部辞書＆計算</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- MathJax CDN for rendering LaTeX formulas -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom styling for the formula cards */
        .formula-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .formula-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        /* Style for the rendered MathJax output */
        .formula-display {
            padding: 1rem 0;
            overflow-x: auto; /* Allows horizontal scrolling for long formulas */
        }
        .MathJax {
            font-size: 120% !important; /* Make formulas a bit larger */
        }
        .calculator-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }
        .calculator-container.active {
            max-height: 500px; /* 適切な値に調整 */
            padding-top: 1rem;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-700 mb-2">公式リファレンス辞書 (内部完結・計算機能付き)</h1>
            <p class="text-gray-600">現在 **122種類** の公式を収録しました！</p>
        </header>

        <!-- 検索エリア -->
        <div class="mb-6 relative">
            <input type="text" id="searchInput" placeholder="公式名、分野、キーワードで検索..."
                   class="w-full p-3 border-2 border-indigo-200 rounded-xl focus:outline-none focus:border-indigo-500 transition duration-150 shadow-md text-lg">
            <!-- 検索サジェスト表示エリア -->
            <div id="suggestContainer" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
                <!-- サジェスト候補はJSで挿入されます -->
            </div>
        </div>

        <!-- カテゴリフィルタ -->
        <div id="filterButtons" class="flex flex-wrap gap-2 mb-8 justify-center">
            <!-- フィルタボタンはJSで生成されます -->
        </div>

        <!-- 結果表示エリア -->
        <div id="resultsContainer" class="space-y-6">
            <!-- 検索結果のカードはここに表示されます -->
        </div>

        <!-- 結果なしメッセージ -->
        <div id="noResults" class="hidden text-center p-8 text-gray-500 bg-white rounded-xl shadow-md">
            <p class="text-xl font-semibold">該当する公式が見つかりませんでした。</p>
            <p>検索キーワードを変更して再度お試しください。</p>
        </div>

        <!-- カスタム通知メッセージ -->
        <div id="notification" class="fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 z-50">
            公式をクリップボードにコピーしました！
        </div>
    </div>

    <script type="module">
        // 外部APIを使わず、内部で全ての公式データを保持します
        // 計算機能に対応するため、variablesとcalculateプロパティを追加しました
        const formulaeData = [
            // --- 数学 (22件 + 計算対応) ---
            { 
                subject: '数学', 
                name: '二次方程式の解の公式', 
                formula: 'ax^2 + bx + c = 0 \\quad \\implies \\quad x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}', 
                description: '二次方程式 $ax^2 + bx + c = 0$ の解を求めるための公式です。判別式 $D = b^2 - 4ac$ を用います。',
                variables: [
                    { id: 'a', label: '係数 $a$', unit: '', type: 'input' },
                    { id: 'b', label: '係数 $b$', unit: '', type: 'input' },
                    { id: 'c', label: '係数 $c$', unit: '', type: 'input' },
                    { id: 'x1', label: '解 $x_1$', unit: '', type: 'output' },
                    { id: 'x2', label: '解 $x_2$', unit: '', type: 'output' }
                ],
                calculate: (a, b, c) => {
                    const discriminant = b * b - 4 * a * c;
                    if (discriminant < 0) return { x1: '虚数解', x2: '虚数解' };
                    const sqrtD = Math.sqrt(discriminant);
                    const x1 = (-b + sqrtD) / (2 * a);
                    const x2 = (-b - sqrtD) / (2 * a);
                    return { x1: x1.toFixed(3), x2: x2.toFixed(3) };
                }
            },
            { 
                subject: '数学', 
                name: '円の面積', 
                formula: 'S = \\pi r^2', 
                description: '半径 $r$ の円の面積 $S$ を求める公式です。',
                variables: [
                    { id: 'r', label: '半径 $r$', unit: 'm', type: 'input' },
                    { id: 'S', label: '面積 $S$', unit: 'm^2', type: 'output' }
                ],
                calculate: (r) => ({ S: (Math.PI * parseFloat(r) * parseFloat(r)).toFixed(3) })
            },
            { subject: '数学', name: '三角関数の加法定理 (sin)', formula: '\\sin(\\alpha + \\beta) = \\sin \\alpha \\cos \\beta + \\cos \\alpha \\sin \\beta', description: '角度の和のサインを、個々の角度のサインとコサインで表現する公式です。' },
            { subject: '数学', name: '微分の基本公式', formula: '\\frac{d}{dx} x^n = n x^{n-1}', description: '冪乗関数の導関数を求める際の基本的な公式です。' },
            { subject: '数学', name: '定積分の基本定理', formula: '\\int_{a}^{b} f(x) dx = F(b) - F(a)', description: '関数 $f(x)$ の原始関数を $F(x)$ としたときの、定積分の値を求める公式です。' },
            { 
                subject: '数学', 
                name: 'ピタゴラスの定理', 
                formula: 'a^2 + b^2 = c^2', 
                description: '直角三角形の斜辺 $c$ の長さを、他の二辺 $a, b$ から求める公式です。',
                variables: [
                    { id: 'a', label: '辺 $a$', unit: 'm', type: 'input' },
                    { id: 'b', label: '辺 $b$', unit: 'm', type: 'input' },
                    { id: 'c', label: '斜辺 $c$', unit: 'm', type: 'output' }
                ],
                calculate: (a, b) => ({ c: Math.sqrt(parseFloat(a) * parseFloat(a) + parseFloat(b) * parseFloat(b)).toFixed(3) })
            },
            { subject: '数学', name: '球の体積', formula: 'V = \\frac{4}{3} \\pi r^3', description: '半径 $r$ の球の体積 $V$ を求める公式です。' },
            // --- 数学 (追加分) ---
            { subject: '数学', name: '対数法則', formula: '\\log_a (xy) = \\log_a x + \\log_a y', description: '積の対数は、それぞれの対数の和に等しいという法則です。' },
            { subject: '数学', name: '正弦定理', formula: '\\frac{a}{\\sin A} = \\frac{b}{\\sin B} = \\frac{c}{\\sin C} = 2R', description: '三角形の外接円の半径 $R$ と辺・角の関係を示す公式です。' },
            { 
                subject: '数学', 
                name: '余弦定理', 
                formula: 'a^2 = b^2 + c^2 - 2bc \\cos A', 
                description: '三角形の任意の辺の長さを、他の二辺の長さとその間の角 $A$ から求める公式です。',
                variables: [
                    { id: 'b', label: '辺 $b$', unit: '', type: 'input' },
                    { id: 'c', label: '辺 $c$', unit: '', type: 'input' },
                    { id: 'A', label: '角 $A$ (度)', unit: '', type: 'input' },
                    { id: 'a', label: '辺 $a$', unit: '', type: 'output' }
                ],
                calculate: (b, c, A) => {
                    const angleRad = A * (Math.PI / 180);
                    const a_sq = b * b + c * c - 2 * b * c * Math.cos(angleRad);
                    return { a: Math.sqrt(a_sq).toFixed(3) };
                }
            },
            { subject: '数学', name: 'tanの加法定理', formula: '\\tan(\\alpha + \\beta) = \\frac{\\tan \\alpha + \\tan \\beta}{1 - \\tan \\alpha \\tan \\beta}', description: '角度の和のタンジェントを計算する公式です。' },
            { subject: '数学', name: '二倍角の公式 (cos)', formula: '\\cos 2\\theta = \\cos^2 \\theta - \\sin^2 \\theta = 2\\cos^2 \\theta - 1 = 1 - 2\\sin^2 \\theta', description: '角度 $2\\theta$ のコサインを $\\theta$ のコサインやサインで表す公式です。' },
            { 
                subject: '数学', 
                name: '等差数列の和', 
                formula: 'S_n = \\frac{n(a_1 + a_n)}{2}', 
                description: '初項 $a_1$、末項 $a_n$、項数 $n$ の等差数列の和 $S_n$ を求める公式です。',
                variables: [
                    { id: 'a1', label: '初項 $a_1$', unit: '', type: 'input' },
                    { id: 'an', label: '末項 $a_n$', unit: '', type: 'input' },
                    { id: 'n', label: '項数 $n$', unit: '', type: 'input' },
                    { id: 'Sn', label: '和 $S_n$', unit: '', type: 'output' }
                ],
                calculate: (a1, an, n) => ({ Sn: ((n * (a1 + an)) / 2).toFixed(0) })
            },
            { subject: '数学', name: '等比数列の一般項', formula: 'a_n = a_1 r^{n-1}', description: '初項 $a_1$、公比 $r$ の等比数列の第 $n$ 項 $a_n$ を求める公式です。' },
            { 
                subject: '数学', 
                name: 'ベクトルの内積', 
                formula: '\\vec{a} \\cdot \\vec{b} = |\\vec{a}| |\\vec{b}| \\cos \\theta', 
                description: 'ベクトル $\\vec{a}$ と $\\vec{b}$ の内積の定義です。$\\theta$ はなす角です。',
                variables: [
                    { id: 'amag', label: '$|\\vec{a}|$', unit: '', type: 'input' },
                    { id: 'bmag', label: '$|\\vec{b}|$', unit: '', type: 'input' },
                    { id: 'theta', label: 'なす角 $\\theta$ (度)', unit: '', type: 'input' },
                    { id: 'dot', label: '内積 $\\vec{a} \\cdot \\vec{b}$', unit: '', type: 'output' }
                ],
                calculate: (amag, bmag, theta) => {
                    const angleRad = theta * (Math.PI / 180);
                    return { dot: (amag * bmag * Math.cos(angleRad)).toFixed(3) };
                }
            },
            { subject: '数学', name: 'オイラーの公式', formula: 'e^{i\\theta} = \\cos \\theta + i \\sin \\theta', description: '指数関数と三角関数の関係を示す、複素解析における基本的な公式です。' },
            { 
                subject: '幾何', 
                name: '台形の面積', 
                formula: 'S = \\frac{1}{2}(a+b)h', 
                description: '上底 $a$、下底 $b$、高さ $h$ の台形の面積 $S$ を求める公式です。',
                variables: [
                    { id: 'a', label: '上底 $a$', unit: 'm', type: 'input' },
                    { id: 'b', label: '下底 $b$', unit: 'm', type: 'input' },
                    { id: 'h', label: '高さ $h$', unit: 'm', type: 'input' },
                    { id: 'S', label: '面積 $S$', unit: 'm^2', type: 'output' }
                ],
                calculate: (a, b, h) => ({ S: (0.5 * (a + b) * h).toFixed(3) })
            },
            { 
                subject: '幾何', 
                name: '平行四辺形の面積', 
                formula: 'S = a h', 
                description: '底辺 $a$、高さ $h$ の平行四辺形の面積 $S$ を求める公式です。',
                variables: [
                    { id: 'a', label: '底辺 $a$', unit: 'm', type: 'input' },
                    { id: 'h', label: '高さ $h$', unit: 'm', type: 'input' },
                    { id: 'S', label: '面積 $S$', unit: 'm^2', type: 'output' }
                ],
                calculate: (a, h) => ({ S: (a * h).toFixed(3) })
            },
            { subject: '幾何', name: '円柱の体積', formula: 'V = \\pi r^2 h', description: '底面の半径 $r$、高さ $h$ の円柱の体積 $V$ を求める公式です。' },
            { subject: '数学', name: '微分（積の法則）', formula: '\\frac{d}{dx} (fg) = f\'g + fg\'', description: '関数 $f(x)$ と $g(x)$ の積の導関数を求める公式です。' },
            { subject: '数学', name: '部分積分', formula: '\\int f(x) g\'(x) dx = f(x) g(x) - \\int f\'(x) g(x) dx', description: '積分を計算するための重要な手法の一つです。' },
            { 
                subject: '幾何', 
                name: '長方形の面積', 
                formula: 'S = a b', 
                description: '辺の長さ $a$ と $b$ の長方形の面積 $S$ を求める公式です。',
                variables: [
                    { id: 'a', label: '縦 $a$', unit: 'm', type: 'input' },
                    { id: 'b', label: '横 $b$', unit: 'm', type: 'input' },
                    { id: 'S', label: '面積 $S$', unit: 'm^2', type: 'output' }
                ],
                calculate: (a, b) => ({ S: (parseFloat(a) * parseFloat(b)).toFixed(3) })
            },
            { subject: '幾何', name: '円錐の体積', formula: 'V = \\frac{1}{3} \\pi r^2 h', description: '底面の半径 $r$、高さ $h$ の円錐の体積 $V$ を求める公式です。' },
            { subject: '幾何', name: '三角形の面積', formula: 'S = \\frac{1}{2} b h', description: '底辺 $b$、高さ $h$ の三角形の面積 $S$ を求める公式です。' },


            // --- 応用数学・統計 (追加分) ---
            { subject: '応用数学', name: '複素数の極形式', formula: 'z = r(\\cos \\theta + i \\sin \\theta)', description: '複素数 $z$ を絶対値 $r$ と偏角 $\\theta$ を使って表す形式です。' },
            { 
                subject: '応用数学', 
                name: '2x2行列の行列式', 
                formula: '\\det(A) = \\det\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix} = ad - bc', 
                description: '2次正方行列 $A$ の行列式を計算する公式です。',
                variables: [
                    { id: 'a', label: '$a$', unit: '', type: 'input' },
                    { id: 'b', label: '$b$', unit: '', type: 'input' },
                    { id: 'c', label: '$c$', unit: '', type: 'input' },
                    { id: 'd', label: '$d$', unit: '', type: 'input' },
                    { id: 'det', label: '行列式 $\\det(A)$', unit: '', type: 'output' }
                ],
                calculate: (a, b, c, d) => ({ det: (a * d - b * c).toFixed(3) })
            },
            { subject: '応用数学', name: '正規分布の確率密度関数', formula: 'f(x) = \\frac{1}{\\sigma \\sqrt{2\\pi}} e^{-\\frac{1}{2}(\\frac{x-\\mu}{\\sigma})^2}', description: '平均 $\\mu$、標準偏差 $\\sigma$ の正規分布に従う確率変数 $x$ の確率密度関数です。' },
            { subject: '応用数学', name: '確率のベイズの定理', formula: 'P(A|B) = \\frac{P(B|A) P(A)}{P(B)}', description: '条件付き確率を計算するための基本的な定理です。' },
            { subject: '応用数学', name: '微分の連鎖律', formula: '\\frac{d}{dx} f(g(x)) = f\'(g(x)) g\'(x)', description: '合成関数の導関数を求めるためのルールです。' },
            { subject: '応用数学', name: 'ロピタルの定理', formula: '\\lim_{x\\to a} \\frac{f(x)}{g(x)} = \\lim_{x\\to a} \\frac{f\'(x)}{g\'(x)}', description: '不定形 $\\frac{0}{0}$ や $\\frac{\\infty}{\\infty}$ の極限を求める際に使用されます。' },
            { 
                subject: '応用数学', 
                name: '等比級数の和', 
                formula: 'S = \\frac{a}{1-r} \\quad (|r| < 1)', 
                description: '初項 $a$、公比 $r$ の無限等比級数の和 $S$ を求める公式です。',
                variables: [
                    { id: 'a', label: '初項 $a$', unit: '', type: 'input' },
                    { id: 'r', label: '公比 $r$ ($|r|<1$)', unit: '', type: 'input' },
                    { id: 'S', label: '和 $S$', unit: '', type: 'output' }
                ],
                calculate: (a, r) => {
                    if (Math.abs(r) >= 1) return { S: '発散 (計算不可)' };
                    return { S: (a / (1 - r)).toFixed(3) };
                }
            },
            { 
                subject: '応用数学', 
                name: '算術平均', 
                formula: '\\bar{x} = \\frac{1}{n} \\sum_{i=1}^n x_i', 
                description: '$n$個のデータ $x_i$ の合計を $n$ で割った算術平均 $\\bar{x}$ の公式です。',
                variables: [
                    { id: 'data', label: 'データ (カンマ区切り)', unit: '', type: 'list-input' },
                    { id: 'avg', label: '平均 $\\bar{x}$', unit: '', type: 'output' }
                ],
                calculate: (data) => {
                    const values = data.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
                    if (values.length === 0) return { avg: 'N/A' };
                    const sum = values.reduce((a, b) => a + b, 0);
                    return { avg: (sum / values.length).toFixed(3) };
                }
            },
            { subject: '応用数学', name: '標準偏差', formula: '\\sigma = \\sqrt{\\frac{1}{n} \\sum_{i=1}^n (x_i - \\bar{x})^2}', description: 'データのばらつき度合いを示す標準偏差 $\\sigma$ の公式です。' },
            { subject: '応用数学', name: '2x2行列の逆行列', formula: 'A^{-1} = \\frac{1}{ad - bc} \\begin{pmatrix} d & -b \\\\ -c & a \\end{pmatrix}', description: '2次正方行列 $A$ の逆行列を求める公式です。行列式 $ad-bc$ がゼロでない場合に存在します。' },
            { subject: '応用数学', name: '二項分布の確率', formula: 'P(X=k) = {}_n C_k p^k (1-p)^{n-k}', description: '試行回数 $n$、成功確率 $p$ の二項分布において、成功回数 $k$ となる確率です。' },
            { subject: '応用数学', name: '信頼区間 (平均)', formula: '\\bar{x} \\pm z_{\\alpha/2} \\frac{\\sigma}{\\sqrt{n}}', description: '標本平均 $\\bar{x}$、母標準偏差 $\\sigma$、標本サイズ $n$ から母平均の信頼区間を推定する公式です。' },
            
            
            // --- 物理 (22件 + 計算対応) ---
            { 
                subject: '物理', 
                name: '運動エネルギー', 
                formula: 'K = \\frac{1}{2}mv^2', 
                description: '質量 $m$ の物体が速度 $v$ で運動しているときに持つエネルギー $K$ です。',
                variables: [
                    { id: 'm', label: '質量 $m$', unit: 'kg', type: 'input' },
                    { id: 'v', label: '速度 $v$', unit: 'm/s', type: 'input' },
                    { id: 'K', label: '運動エネルギー $K$', unit: 'J', type: 'output' }
                ],
                calculate: (m, v) => ({ K: (0.5 * parseFloat(m) * parseFloat(v) * parseFloat(v)).toFixed(3) })
            },
            { 
                subject: '物理', 
                name: 'ニュートンの運動の第2法則', 
                formula: 'F = ma', 
                description: '物体に働く力 $F$ は、物体の質量 $m$ と加速度 $a$ の積に等しいという法則です。',
                variables: [
                    { id: 'm', label: '質量 $m$', unit: 'kg', type: 'input' },
                    { id: 'a', label: '加速度 $a$', unit: 'm/s^2', type: 'input' },
                    { id: 'F', label: '力 $F$', unit: 'N', type: 'output' }
                ],
                calculate: (m, a) => ({ F: (parseFloat(m) * parseFloat(a)).toFixed(3) })
            },
            { subject: '物理', name: '万有引力の法則', formula: 'F = G \\frac{m_1 m_2}{r^2}', description: '質量 $m_1$ と $m_2$ の物体が距離 $r$ で引き合う力 $F$ を示します。$G$ は万有引力定数です。' },
            { subject: '物理', name: '光速', formula: 'c = \\frac{1}{\\sqrt{\\epsilon_0 \\mu_0}}', description: '真空中の光速 $c$ を、真空の誘電率 $\\epsilon_0$ と透磁率 $\\mu_0$ で表した公式です。' },
            { subject: '物理', name: '特殊相対性理論（エネルギー）', formula: 'E = mc^2', description: '質量 $m$ はエネルギー $E$ に変換できることを示す、有名な質量とエネルギーの等価性の公式です。' },
            { 
                subject: '物理', 
                name: '仕事 (W)', 
                formula: 'W = Fs', 
                description: '力 $F$ が物体を距離 $s$ 移動させたときに行われる仕事 $W$ です。',
                variables: [
                    { id: 'F', label: '力 $F$', unit: 'N', type: 'input' },
                    { id: 's', label: '距離 $s$', unit: 'm', type: 'input' },
                    { id: 'W', label: '仕事 $W$', unit: 'J', type: 'output' }
                ],
                calculate: (F, s) => ({ W: (parseFloat(F) * parseFloat(s)).toFixed(3) })
            },
            { subject: '物理', name: '圧力の定義', formula: 'P = \\frac{F}{A}', description: '面積 $A$ に垂直に働く力 $F$ によって生じる圧力 $P$ の公式です。' },
            { subject: '物理', name: '運動量', formula: 'p = mv', description: '質量 $m$ と速度 $v$ を持つ物体の運動量 $p$ の公式です。' },
            { subject: '物理', name: '熱量（比熱）', formula: 'Q = mc\\Delta T', description: '質量 $m$、比熱 $c$ の物体の温度を $\\Delta T$ だけ変化させるのに必要な熱量 $Q$ の公式です。' },
            { subject: '物理', name: '波の速度', formula: 'v = f \\lambda', description: '波の速さ $v$ は、振動数 $f$ と波長 $\\lambda$ の積に等しいという公式です。' },
            // --- 物理 (追加分) ---
            { 
                subject: '物理', 
                name: '自由落下距離', 
                formula: 'y = \\frac{1}{2} g t^2', 
                description: '初速 $0$ の物体が時間 $t$ で落下する距離 $y$ です。$g$ は重力加速度 ($9.8 \\text{ m/s}^2$) です。',
                variables: [
                    { id: 't', label: '時間 $t$', unit: 's', type: 'input' },
                    { id: 'y', label: '落下距離 $y$', unit: 'm', type: 'output' }
                ],
                calculate: (t) => ({ y: (0.5 * 9.8 * t * t).toFixed(3) })
            },
            { 
                subject: '物理', 
                name: 'フックの法則', 
                formula: 'F = -kx', 
                description: 'ばねの弾性力 $F$ は、ばね定数 $k$ と伸び（縮み）の長さ $x$ に比例します。',
                variables: [
                    { id: 'k', label: 'ばね定数 $k$', unit: 'N/m', type: 'input' },
                    { id: 'x', label: '伸び/縮み $x$', unit: 'm', type: 'input' },
                    { id: 'F', label: '弾性力 $F$ (絶対値)', unit: 'N', type: 'output' }
                ],
                calculate: (k, x) => ({ F: (k * x).toFixed(3) })
            },
            { subject: '物理', name: '慣性の法則', formula: '\\sum F = 0 \\implies \\vec{v} = \\text{const}', description: '物体に作用する合力 $\\sum F$ がゼロのとき、物体は等速直線運動（静止を含む）を続けます。' },
            { subject: '物理', name: 'エネルギー保存則', formula: 'E_{total} = K + U = \\text{const}', description: '外力が仕事をしないとき、運動エネルギー $K$ とポテンシャルエネルギー $U$ の和は一定に保たれます。' },
            { subject: '物理', name: '仕事率', formula: 'P = \\frac{W}{t}', description: '時間 $t$ あたりに行われる仕事 $W$ の割合、仕事率 $P$ の公式です。' },
            { subject: '物理', name: '熱力学第1法則', formula: '\\Delta U = Q + W', description: '系の内部エネルギーの変化 $\\Delta U$ は、系に与えられた熱量 $Q$ と、系にされた仕事 $W$ の和に等しい。' },
            { subject: '物理', name: 'ドップラー効果 (音源接近)', formula: 'f\' = f \\frac{V}{V - v_s}', description: '音源 $v_s$ が観測者に向かってくる場合の、観測される振動数 $f\'$ の公式です。$V$ は音速です。' },
            { subject: '物理', name: '屈折の法則（スネルの法則）', formula: 'n_1 \\sin \\theta_1 = n_2 \\sin \\theta_2', description: '異なる媒質 $n_1, n_2$ の境界面で光が屈折する際の、入射角 $\\theta_1$ と屈折角 $\\theta_2$ の関係です。' },
            { subject: '物理', name: '等速円運動の向心加速度', formula: 'a = \\frac{v^2}{r}', description: '速さ $v$ で半径 $r$ の円周上を運動する物体の中心向きの加速度 $a$ です。' },
            { 
                subject: '物理', 
                name: 'ポテンシャルエネルギー (重力)', 
                formula: 'U = mgh', 
                description: '質量 $m$ の物体が基準面から高さ $h$ にあるときの重力による位置エネルギー $U$ です。$g$ は重力加速度 ($9.8 \\text{ m/s}^2$) です。',
                variables: [
                    { id: 'm', label: '質量 $m$', unit: 'kg', type: 'input' },
                    { id: 'h', label: '高さ $h$', unit: 'm', type: 'input' },
                    { id: 'U', label: '位置エネルギー $U$', unit: 'J', type: 'output' }
                ],
                calculate: (m, h) => ({ U: (m * 9.8 * h).toFixed(3) })
            },
            { subject: '物理', name: '静電気力（クーロンの法則）', formula: 'F = k \\frac{q_1 q_2}{r^2}', description: '電荷 $q_1$ と $q_2$ の間に距離 $r$ で働く静電気力 $F$ です。$k$ はクーロン定数です。' },
            { subject: '物理', name: '運動量', formula: 'p = mv', description: '質量 $m$ と速度 $v$ を持つ物体の運動量 $p$ の公式です。' },


            // --- 熱力学・流体力学 (追加分) ---
            { 
                subject: '熱力学', 
                name: 'カルノーサイクルの効率', 
                formula: '\\eta = 1 - \\frac{T_C}{T_H}', 
                description: '高温熱源 $T_H$ と低温熱源 $T_C$ の熱機関の最大熱効率 $\\eta$ を示す公式です。',
                variables: [
                    { id: 'Tc', label: '低温 $T_C$', unit: 'K', type: 'input' },
                    { id: 'Th', label: '高温 $T_H$', unit: 'K', type: 'input' },
                    { id: 'eta', label: '効率 $\\eta$', unit: '', type: 'output' }
                ],
                calculate: (Tc, Th) => {
                    if (Th <= 0 || Tc < 0 || Tc >= Th) return { eta: 'Error' };
                    return { eta: (1 - (Tc / Th)).toFixed(3) };
                }
            },
            { subject: '熱力学', name: 'エントロピー変化', formula: '\\Delta S = \\frac{Q}{T}', description: '温度 $T$ で熱 $Q$ が移動したときの系のエントロピー変化 $\\Delta S$ です。' },
            { subject: '熱力学', name: 'マイヤーの関係式', formula: 'C_P - C_V = R', description: '定圧モル比熱 $C_P$ と定積モル比熱 $C_V$ の差が気体定数 $R$ に等しいという関係です。' },
            { subject: '熱力学', name: '断熱過程（ポアソンの式）', formula: 'P V^{\\gamma} = \\text{const.}', description: '断熱変化における圧力 $P$ と体積 $V$ の関係です。$\\gamma$ は比熱比です。' },
            { subject: '流体力学', name: 'ベルヌーイの定理', formula: 'P + \\frac{1}{2} \\rho v^2 + \\rho g h = \\text{const.}', description: '非圧縮性流体の運動において、圧力、運動、位置のエネルギーの和が一定であるという定理です。' },
            { 
                subject: '流体力学', 
                name: '連続の式', 
                formula: 'A_1 v_1 = A_2 v_2', 
                description: '非圧縮性流体の流れにおいて、断面積 $A$ と流速 $v$ の積が一定であるという法則です。',
                variables: [
                    { id: 'A1', label: '断面積 $A_1$', unit: 'm^2', type: 'input' },
                    { id: 'v1', label: '流速 $v_1$', unit: 'm/s', type: 'input' },
                    { id: 'A2', label: '断面積 $A_2$', unit: 'm^2', type: 'input' },
                    { id: 'v2', label: '流速 $v_2$', unit: 'm/s', type: 'output' }
                ],
                calculate: (A1, v1, A2) => {
                    if (A2 === 0) return { v2: 'Error (0除算)' };
                    return { v2: ((A1 * v1) / A2).toFixed(3) };
                }
            },
            { subject: '流体力学', name: 'レイノルズ数', formula: 'R_e = \\frac{\\rho v L}{\\mu}', description: '流れの慣性力と粘性力の比を示す無次元数です。流れの層流・乱流の判定に使われます。' },
            { subject: '熱力学', name: '自由エネルギー変化', formula: '\\Delta G = \\Delta H - T \\Delta S', description: '反応の自発性を判断するギブズの自由エネルギーの変化 $\\Delta G$ の定義式です。' },
            { subject: '熱力学', name: '比熱比', formula: '\\gamma = \\frac{C_P}{C_V}', description: '定圧モル比熱 $C_P$ と定積モル比熱 $C_V$ の比率です。' },
            { subject: '流体力学', name: '粘性抵抗（ストークスの法則）', formula: 'F = 6 \\pi \\eta r v', description: '半径 $r$ の球体が粘度 $\\eta$ の流体中を速度 $v$ で移動するときの抵抗力 $F$ です。' },


            // --- 電気・電子 (24件 + 計算対応) ---
            { 
                subject: '電気', 
                name: 'オームの法則', 
                formula: 'V = IR', 
                description: '抵抗 $R$ の電気回路における電圧 $V$ と電流 $I$ の基本的な関係式です。',
                variables: [
                    { id: 'I', label: '電流 $I$', unit: 'A', type: 'input' },
                    { id: 'R', label: '抵抗 $R$', unit: '\\Omega', type: 'input' },
                    { id: 'V', label: '電圧 $V$', unit: 'V', type: 'output' }
                ],
                calculate: (I, R) => ({ V: (parseFloat(I) * parseFloat(R)).toFixed(3) })
            },
            { 
                subject: '電気', 
                name: '電力の公式', 
                formula: 'P = VI', 
                description: '電圧 $V$ と電流 $I$ によって消費される電力 $P$ を求める公式です。',
                variables: [
                    { id: 'V', label: '電圧 $V$', unit: 'V', type: 'input' },
                    { id: 'I', label: '電流 $I$', unit: 'A', type: 'input' },
                    { id: 'P', label: '電力 $P$', unit: 'W', type: 'output' }
                ],
                calculate: (V, I) => ({ P: (parseFloat(V) * parseFloat(I)).toFixed(3) })
            },
            { subject: '電気', name: 'コンデンサの静電エネルギー', formula: 'U = \\frac{1}{2} C V^2', description: '静電容量 $C$ のコンデンサに蓄えられるエネルギー $U$ を示します。$V$ は電圧です。' },
            { subject: '電気', name: 'キルヒホッフの電流則', formula: '\\sum I_{in} = \\sum I_{out}', description: '回路の任意の接点（ノード）に入る電流の和は、その接点から出る電流の和に等しいという法則です。' },
            { subject: '電気', name: 'コイルのインダクタンスの誘導起電力', formula: 'V = -L \\frac{dI}{dt}', description: '自己インダクタンス $L$ のコイルに流れる電流 $I$ の変化率によって生じる誘導起電力 $V$ を示す公式です。' },
            { 
                subject: '電気', 
                name: '直列合成抵抗', 
                formula: 'R_{total} = R_1 + R_2 + \\dots + R_n', 
                description: '複数の抵抗 $R_1, R_2, \\dots$ を直列に接続した場合の合成抵抗を求める公式です。',
                variables: [
                    { id: 'R1', label: '抵抗 $R_1$', unit: '\\Omega', type: 'input' },
                    { id: 'R2', label: '抵抗 $R_2$', unit: '\\Omega', type: 'input' },
                    { id: 'Rt', label: '合成抵抗 $R_{total}$', unit: '\\Omega', type: 'output' }
                ],
                calculate: (R1, R2) => ({ Rt: (parseFloat(R1) + parseFloat(R2)).toFixed(3) })
            },
            { 
                subject: '電気', 
                name: '並列合成抵抗', 
                formula: '\\frac{1}{R_{total}} = \\frac{1}{R_1} + \\frac{1}{R_2} + \\dots + \\frac{1}{R_n}', 
                description: '複数の抵抗 $R_1, R_2, \\dots$ を並列に接続した場合の合成抵抗を求める公式です。（2つの抵抗の場合、$\\frac{R_1 R_2}{R_1 + R_2}$）',
                variables: [
                    { id: 'R1', label: '抵抗 $R_1$', unit: '\\Omega', type: 'input' },
                    { id: 'R2', label: '抵抗 $R_2$', unit: '\\Omega', type: 'input' },
                    { id: 'Rt', label: '合成抵抗 $R_{total}$', unit: '\\Omega', type: 'output' }
                ],
                calculate: (R1, R2) => {
                    const r1 = parseFloat(R1);
                    const r2 = parseFloat(R2);
                    if (r1 + r2 === 0) return { Rt: 'Error (0除算)' };
                    return { Rt: ((r1 * r2) / (r1 + r2)).toFixed(3) };
                }
            },
            { subject: '電気', name: 'インピーダンス (RL直列)', formula: 'Z = \\sqrt{R^2 + (\\omega L)^2}', description: '抵抗 $R$ とコイル $L$ の直列回路のインピーダンス $Z$ です。$\\omega$ は角周波数。' },
            { subject: '電気', name: '交流実効値 (正弦波)', formula: 'V_{rms} = \\frac{V_{max}}{\\sqrt{2}}', description: '正弦波交流電圧の最大値 $V_{max}$ から実効値 $V_{rms}$ を求める公式です。' },
            { subject: '電気', name: '周波数と角周波数', formula: '\\omega = 2 \\pi f', description: '周波数 $f$ と角周波数 $\\omega$ の関係です。' },
            // --- 電気 (追加分) ---
            { 
                subject: '電気', 
                name: '分圧の法則', 
                formula: 'V_x = V_{total} \\frac{R_x}{R_{total}}', 
                description: '直列回路において、抵抗 $R_x$ にかかる電圧 $V_x$ を求める公式です。$V_{total}$ は全体の電圧です。',
                variables: [
                    { id: 'V_t', label: '全体の電圧 $V_{total}$', unit: 'V', type: 'input' },
                    { id: 'R_x', label: '着目抵抗 $R_x$', unit: '\\Omega', type: 'input' },
                    { id: 'R_t', label: '全体の抵抗 $R_{total}$', unit: '\\Omega', type: 'input' },
                    { id: 'V_x', label: '電圧 $V_x$', unit: 'V', type: 'output' }
                ],
                calculate: (Vt, Rx, Rt) => ({ V_x: ((Vt * Rx) / Rt).toFixed(3) })
            },
            { 
                subject: '電気', 
                name: '分流の法則 (2抵抗)', 
                formula: 'I_2 = I_{total} \\frac{R_1}{R_1 + R_2}', 
                description: '抵抗 $R_1, R_2$ の並列回路において、全体の電流 $I_{total}$ から $R_2$ に流れる電流 $I_2$ を求める公式です。',
                variables: [
                    { id: 'I_t', label: '全体の電流 $I_{total}$', unit: 'A', type: 'input' },
                    { id: 'R1', label: '抵抗 $R_1$', unit: '\\Omega', type: 'input' },
                    { id: 'R2', label: '抵抗 $R_2$', unit: '\\Omega', type: 'input' },
                    { id: 'I2', label: '電流 $I_2$', unit: 'A', type: 'output' }
                ],
                calculate: (It, R1, R2) => ({ I2: ((It * R1) / (R1 + R2)).toFixed(3) })
            },
            { 
                subject: '電気', 
                name: '容量性リアクタンス', 
                formula: 'X_C = \\frac{1}{2 \\pi f C}', 
                description: '周波数 $f$ と静電容量 $C$ によって決まるコンデンサのリアクタンス $X_C$ です。',
                variables: [
                    { id: 'f', label: '周波数 $f$', unit: 'Hz', type: 'input' },
                    { id: 'C', label: '静電容量 $C$', unit: 'F (ファラド)', type: 'input' },
                    { id: 'Xc', label: 'リアクタンス $X_C$', unit: '\\Omega', type: 'output' }
                ],
                calculate: (f, C) => ({ Xc: (1 / (2 * Math.PI * f * C)).toFixed(3) })
            },
            { 
                subject: '電気', 
                name: '誘導性リアクタンス', 
                formula: 'X_L = 2 \\pi f L', 
                description: '周波数 $f$ とインダクタンス $L$ によって決まるコイルのリアクタンス $X_L$ です。',
                variables: [
                    { id: 'f', label: '周波数 $f$', unit: 'Hz', type: 'input' },
                    { id: 'L', label: 'インダクタンス $L$', unit: 'H (ヘンリー)', type: 'input' },
                    { id: 'Xl', label: 'リアクタンス $X_L$', unit: '\\Omega', type: 'output' }
                ],
                calculate: (f, L) => ({ Xl: (2 * Math.PI * f * L).toFixed(3) })
            },
            { subject: '電気', name: 'RLC直列共振周波数', formula: 'f_0 = \\frac{1}{2 \\pi \\sqrt{L C}}', description: 'RLC直列回路の共振周波数 $f_0$ です。$L$ はインダクタンス、$C$ は静電容量です。' },
            { subject: '電気', name: 'ローレンツ力', formula: '\\vec{F} = q (\\vec{E} + \\vec{v} \\times \\vec{B})', description: '電場 $\\vec{E}$ と磁場 $\\vec{B}$ の中を運動する電荷 $q$ に働く力 $\\vec{F}$ です。' },
            { subject: '電気', name: '静電容量の定義', formula: 'Q = C V', description: 'コンデンサの静電容量 $C$ は、蓄えられた電荷 $Q$ と電圧 $V$ の比で定義されます。' },
            { subject: '電気', name: '電界の強さ', formula: 'E = \\frac{V}{d}', description: '電極間の距離 $d$ と電圧 $V$ から電界の強さ $E$ を求める公式です。' },
            { 
                subject: '電気', 
                name: 'コンデンサの直列合成容量', 
                formula: '\\frac{1}{C_{total}} = \\frac{1}{C_1} + \\frac{1}{C_2} + \\dots', 
                description: 'コンデンサを直列に接続した場合の合成容量 $C_{total}$ を求める公式です。（抵抗の並列合成と同じ形）',
                variables: [
                    { id: 'C1', label: '容量 $C_1$', unit: 'F', type: 'input' },
                    { id: 'C2', label: '容量 $C_2$', unit: 'F', type: 'input' },
                    { id: 'Ct', label: '合成容量 $C_{total}$', unit: 'F', type: 'output' }
                ],
                calculate: (C1, C2) => {
                    const c1 = parseFloat(C1);
                    const c2 = parseFloat(C2);
                    if (c1 === 0 || c2 === 0) return { Ct: 'Error (0除算)' };
                    return { Ct: ((c1 * c2) / (c1 + c2)).toFixed(6) }; // 容量は小さい値になることが多いため
                }
            },
            { 
                subject: '電気', 
                name: 'コンデンサの並列合成容量', 
                formula: 'C_{total} = C_1 + C_2 + \\dots', 
                description: 'コンデンサを並列に接続した場合の合成容量 $C_{total}$ を求める公式です。（抵抗の直列合成と同じ形）',
                variables: [
                    { id: 'C1', label: '容量 $C_1$', unit: 'F', type: 'input' },
                    { id: 'C2', label: '容量 $C_2$', unit: 'F', type: 'input' },
                    { id: 'Ct', label: '合成容量 $C_{total}$', unit: 'F', type: 'output' }
                ],
                calculate: (C1, C2) => ({ Ct: (parseFloat(C1) + parseFloat(C2)).toFixed(6) })
            },
            { subject: '電気', name: '交流電力の皮相電力', formula: 'S = V I', description: '交流回路における電圧 $V$ と電流 $I$ の積で表される皮相電力 $S$ の公式です。' },
            { 
                subject: '電気', 
                name: '三相交流（Y結線）', 
                formula: 'V_L = \\sqrt{3} V_P', 
                description: 'Y結線における線間電圧 $V_L$ と相電圧 $V_P$ の関係です。',
                variables: [
                    { id: 'Vp', label: '相電圧 $V_P$', unit: 'V', type: 'input' },
                    { id: 'Vl', label: '線間電圧 $V_L$', unit: 'V', type: 'output' }
                ],
                calculate: (Vp) => ({ Vl: (Vp * Math.sqrt(3)).toFixed(3) })
            },
            { subject: '電気', name: '電線の抵抗率', formula: 'R = \\rho \\frac{L}{A}', description: '長さ $L$、断面積 $A$ の電線の抵抗 $R$ です。$\\rho$ は抵抗率です。' },
            { subject: '電気', name: 'アンペールの法則', formula: '\\oint \\vec{B} \\cdot d\\vec{l} = \\mu_0 I', description: '閉じた経路に沿った磁場 $\\vec{B}$ の線積分が、その経路を貫く電流 $I$ に比例するという法則です。' },
            { 
                subject: '電気', 
                name: '電力（抵抗換算）', 
                formula: 'P = I^2 R = \\frac{V^2}{R}', 
                description: 'オームの法則を用いて電流 $I$ や電圧 $V$ から電力 $P$ を求める公式です。',
                variables: [
                    { id: 'V', label: '電圧 $V$', unit: 'V', type: 'input' },
                    { id: 'R', label: '抵抗 $R$', unit: '\\Omega', type: 'input' },
                    { id: 'P', label: '電力 $P$', unit: 'W', type: 'output' }
                ],
                calculate: (V, R) => {
                    if (R === 0) return { P: 'Error (0除算)' };
                    return { P: (V * V / R).toFixed(3) };
                }
            },


            // --- 化学 (18件 + 計算対応) ---
            { 
                subject: '化学', 
                name: '理想気体の状態方程式', 
                formula: 'PV = nRT', 
                description: '圧力 $P$、体積 $V$、物質量 $n$、絶対温度 $T$ の間の関係を示す公式です。$R$ は気体定数（$8.314 \\text{ J/(mol}\\cdot\\text{K)}$）です。',
                variables: [
                    { id: 'n', label: '物質量 $n$', unit: 'mol', type: 'input' },
                    { id: 'T', label: '温度 $T$', unit: 'K', type: 'input' },
                    { id: 'V', label: '体積 $V$', unit: 'm^3', type: 'input' },
                    { id: 'P', label: '圧力 $P$', unit: 'Pa', type: 'output' }
                ],
                calculate: (n, T, V) => {
                    const R = 8.314; // 気体定数
                    return { P: ((parseFloat(n) * R * parseFloat(T)) / parseFloat(V)).toFixed(3) };
                }
            },
            { 
                subject: '化学', 
                name: 'モル濃度', 
                formula: 'C = \\frac{n}{V}', 
                description: '溶液の体積 $V$ に対する溶質の物質量 $n$ の比率であるモル濃度 $C$ を定義する公式です。',
                variables: [
                    { id: 'n', label: '物質量 $n$', unit: 'mol', type: 'input' },
                    { id: 'V', label: '体積 $V$', unit: 'L', type: 'input' },
                    { id: 'C', label: 'モル濃度 $C$', unit: 'mol/L', type: 'output' }
                ],
                calculate: (n, V) => ({ C: (parseFloat(n) / parseFloat(V)).toFixed(3) })
            },
            { subject: '化学', name: 'pHの定義', formula: 'pH = -\\log_{10}[H^+]', description: '水素イオン濃度 $[H^+]$ から水溶液の酸性度を示すpHを計算する公式です。' },
            { subject: '化学', name: '質量パーセント濃度', formula: 'C_{\\text{mass}} = \\frac{m_{\\text{solute}}}{m_{\\text{solution}}} \\times 100', description: '溶液の質量に対する溶質の質量の割合です。' },
            // --- 応用化学 (追加分) ---
            { subject: '化学', name: 'ネルンストの式', formula: 'E = E^0 - \\frac{RT}{nF} \\ln Q', description: '標準電極電位 $E^0$ から、濃度や分圧が標準状態ではない場合の電極電位 $E$ を求める式です。' },
            { subject: '化学', name: 'ギブズ自由エネルギー', formula: '\\Delta G^0 = -RT \\ln K', description: '標準状態におけるギブズ自由エネルギー変化 $\\Delta G^0$ と平衡定数 $K$ の関係です。' },
            { subject: '化学', name: '平衡定数', formula: 'K = \\frac{[C]^c [D]^d}{[A]^a [B]^b}', description: '可逆反応 $aA + bB \\rightleftharpoons cC + dD$ の濃度を用いた平衡定数 $K$ の定義式です。' },
            { 
                subject: '化学', 
                name: '半減期（一次反応）', 
                formula: 't_{1/2} = \\frac{\\ln 2}{k}', 
                description: '一次反応における反応速度定数 $k$ から半減期 $t_{1/2}$ を求める公式です。',
                variables: [
                    { id: 'k', label: '速度定数 $k$', unit: 's^{-1}', type: 'input' },
                    { id: 't12', label: '半減期 $t_{1/2}$', unit: 's', type: 'output' }
                ],
                calculate: (k) => {
                    if (k <= 0) return { t12: 'Error' };
                    return { t12: (Math.log(2) / k).toFixed(3) };
                }
            },
            { subject: '化学', name: 'アレニウスの式', formula: 'k = A e^{-E_a / RT}', description: '反応速度定数 $k$ と絶対温度 $T$ の関係を示す式です。$E_a$ は活性化エネルギーです。' },
            { subject: '化学', name: '圧平衡定数', formula: 'K_p = K_c (RT)^{\\Delta n}', description: '濃度平衡定数 $K_c$ から分圧平衡定数 $K_p$ を換算する公式です。$\\Delta n$ は生成系と反応系のモル数の差です。' },
            { 
                subject: '化学', 
                name: '沸点上昇', 
                formula: '\\Delta T_b = K_b m', 
                description: '非揮発性溶質を溶かしたときの沸点上昇度 $\\Delta T_b$ を、モル沸点上昇 $K_b$ と質量モル濃度 $m$ から求める公式です。',
                variables: [
                    { id: 'Kb', label: 'モル沸点上昇 $K_b$', unit: 'K\\cdot kg/mol', type: 'input' },
                    { id: 'm', label: '質量モル濃度 $m$', unit: 'mol/kg', type: 'input' },
                    { id: 'dTb', label: '沸点上昇 $\\Delta T_b$', unit: 'K', type: 'output' }
                ],
                calculate: (Kb, m) => ({ dTb: (Kb * m).toFixed(3) })
            },
            { 
                subject: '化学', 
                name: '浸透圧', 
                formula: '\\Pi = c R T', 
                description: '溶液の浸透圧 $\\Pi$ を、モル濃度 $c$、気体定数 $R$、絶対温度 $T$ から求める公式です。',
                variables: [
                    { id: 'c', label: 'モル濃度 $c$', unit: 'mol/L', type: 'input' },
                    { id: 'T', label: '温度 $T$', unit: 'K', type: 'input' },
                    { id: 'Pi', label: '浸透圧 $\\Pi$', unit: 'Pa', type: 'output' }
                ],
                calculate: (c, T) => {
                    const R = 8.314; // 気体定数
                    return { Pi: (c * R * T).toFixed(3) };
                }
            },
            { subject: '化学', name: '電気陰性度 (ポーリング)', formula: 'E_A - E_B = 0.208 \\sqrt{\\Delta}', description: '原子AとBの電気陰性度の差を、結合解離エネルギーの差 $\\Delta$ から推定する式です。' },
            { subject: '化学', name: '溶解度積', formula: 'K_{sp} = [A^n]^m [B^m]^n', description: '難溶性塩 $A_m B_n$ の飽和溶液におけるイオン濃度積の定数です。' },
            { subject: '化学', name: 'ヘンリーの法則', formula: 'P = k_H c', description: '気体の溶解度 $c$ は、その気体の分圧 $P$ に比例するという法則です。$k_H$ はヘンリー定数です。' },
            { subject: '化学', name: 'ポアソン分布', formula: 'P(X=k) = \\frac{\\lambda^k e^{-\\lambda}}{k!}', description: 'めったに起こらない事象が単位時間あたりに $k$ 回発生する確率を求める離散確率分布です。' },
            { subject: '化学', name: '分圧の法則（ドルトン）', formula: 'P_{\\text{total}} = P_1 + P_2 + \\dots', description: '混合気体の全圧は、各成分気体の分圧の和に等しいという法則です。' },
            { subject: '化学', name: '気体の拡散速度', formula: '\\frac{v_1}{v_2} = \\sqrt{\\frac{M_2}{M_1}}', description: '気体の拡散速度 $v$ は、そのモル質量 $M$ の平方根に反比例するという法則です（グラハムの法則）。' },


            // --- 情報科学・金融 (12件 + 計算対応) ---
            { subject: '情報科学', name: 'シャノンの情報理論 (エントロピー)', formula: 'H = - \\sum_{i=1}^n p_i \\log_2 p_i', description: '情報源の不確実性の度合いを示すエントロピー $H$ の公式です。$p_i$ は事象 $i$ の発生確率です。' },
            { subject: '情報科学', name: 'ビッグオー記法（対数時間）', formula: 'O(\\log n)', description: 'アルゴリズムの計算量が、入力サイズ $n$ の対数に比例することを示します（二分探索など）。' },
            { subject: '情報科学', name: 'ビッグオー記法（線形時間）', formula: 'O(n)', description: 'アルゴリズムの計算量が、入力サイズ $n$ に比例することを示します（配列の単純な走査など）。' },
            { subject: '情報科学', name: 'ビッグオー記法（二乗時間）', formula: 'O(n^2)', description: 'アルゴリズムの計算量が、入力サイズ $n$ の二乗に比例することを示します（バブルソートなど）。' },
            { subject: '情報科学', name: 'ハミング距離', formula: 'D_H = \\sum_{i=1}^k (a_i \\oplus b_i)', description: '同じ長さの2つの文字列の、対応する位置にある文字が異なる個数（排他的論理和の総和）です。' },
            { subject: '情報科学', name: '二分木（最大ノード数）', formula: 'N_{\\max} = 2^{h+1} - 1', description: '高さ $h$ の完全二分木に含まれる最大ノード数 $N_{\\max}$ を求める公式です。' },
            { 
                subject: '情報科学', 
                name: 'ハッシュ関数（剰余）', 
                formula: 'h(k) = k \\pmod{m}', 
                description: 'キー $k$ をハッシュテーブルのサイズ $m$ で割った余り $h(k)$ をハッシュ値とする、基本的なハッシュ関数です。',
                variables: [
                    { id: 'k', label: 'キー $k$', unit: '整数', type: 'input' },
                    { id: 'm', label: 'サイズ $m$', unit: '整数', type: 'input' },
                    { id: 'h_k', label: 'ハッシュ値 $h(k)$', unit: '', type: 'output' }
                ],
                calculate: (k, m) => {
                    if (m <= 0) return { h_k: 'Error (サイズ>0)' };
                    return { h_k: (k % m).toFixed(0) };
                }
            },
            { 
                subject: '情報科学', 
                name: '圧縮率', 
                formula: '\\text{Compression Ratio} = 1 - \\frac{\\text{Compressed Size}}{\\text{Original Size}}', 
                description: '圧縮後のサイズから、元のサイズに対してどれだけ情報量が減ったかを示す割合です。',
                variables: [
                    { id: 'original', label: '元のサイズ', unit: 'byte', type: 'input' },
                    { id: 'compressed', label: '圧縮サイズ', unit: 'byte', type: 'input' },
                    { id: 'ratio', label: '圧縮率', unit: '%', type: 'output' }
                ],
                calculate: (original, compressed) => {
                    if (original === 0) return { ratio: 'Error' };
                    const ratio = 1 - (compressed / original);
                    return { ratio: (ratio * 100).toFixed(2) };
                }
            },
            { subject: '情報科学', name: 'ビットレート', formula: '\\text{Bitrate} = \\frac{\\text{Data Size}}{\\text{Time}}', description: '単位時間あたりに転送されるデータ量（ビット数）を示す公式です。' },
            { 
                subject: '金融', 
                name: '単利計算', 
                formula: 'A = P (1 + rt)', 
                description: '元金 $P$、年利率 $r$、期間 $t$ における将来価値 $A$ を求める単利計算の公式です。',
                variables: [
                    { id: 'P', label: '元金 $P$', unit: '円', type: 'input' },
                    { id: 'r', label: '年利率 $r$ (小数)', unit: '', type: 'input' },
                    { id: 't', label: '期間 $t$', unit: '年', type: 'input' },
                    { id: 'A', label: '将来価値 $A$', unit: '円', type: 'output' }
                ],
                calculate: (P, r, t) => ({ A: (parseFloat(P) * (1 + parseFloat(r) * parseFloat(t))).toFixed(0) })
            },
            { subject: '金融', name: '複利計算', formula: 'A = P (1 + \\frac{r}{n})^{nt}', description: '元金 $P$ が年 $n$ 回複利計算される場合の、将来価値 $A$ を求める公式です。' },
            { subject: '金融', name: '割引率', formula: '\\text{Discount Factor} = \\frac{1}{(1+r)^t}', description: '将来の価値を現在の価値に換算するための割引率を求める公式です。' }

        ];

        const searchInput = document.getElementById('searchInput');
        const suggestContainer = document.getElementById('suggestContainer'); // 新規追加
        const resultsContainer = document.getElementById('resultsContainer');
        const noResults = document.getElementById('noResults');
        const filterButtons = document.getElementById('filterButtons');
        let currentFilter = '全て'; // 現在のフィルタリングカテゴリ

        // デバウンス関数（入力の頻繁な処理を防ぐ）
        const debounce = (func, delay) => {
            let timeoutId;
            return function(...args) {
                const context = this;
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(context, args), delay);
            };
        };

        // --- 便利な機能 1: カテゴリフィルタの生成 ---
        const generateFilterButtons = () => {
            const allSubjects = formulaeData.map(f => f.subject);
            // '数学'と'応用数学'のように近いカテゴリを近くに配置するためにソート順を調整
            const subjectsOrder = ['全て', '数学', '応用数学', '幾何', '物理', '熱力学', '流体力学', '電気', '化学', '情報科学', '金融'];
            const subjectsSet = new Set(allSubjects);
            let subjects = subjectsOrder.filter(s => s === '全て' || subjectsSet.has(s));
            
            // subjectsOrderに含まれていないカテゴリを末尾に追加
            subjectsSet.forEach(s => {
                if (!subjectsOrder.includes(s)) {
                    subjects.push(s);
                }
            });
            
            filterButtons.innerHTML = ''; // ボタンをクリア
            subjects.forEach(subject => {
                const button = document.createElement('button');
                button.textContent = subject;
                button.className = `filter-button px-4 py-2 rounded-full font-semibold transition duration-150 ease-in-out text-sm shadow-md ${
                    subject === currentFilter ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-white text-indigo-600 border border-indigo-400 hover:bg-indigo-100'
                }`;
                button.addEventListener('click', () => {
                    currentFilter = subject;
                    updateFilterButtonStyles();
                    searchFormulas();
                });
                filterButtons.appendChild(button);
            });
        };

        const updateFilterButtonStyles = () => {
            document.querySelectorAll('.filter-button').forEach(button => {
                if (button.textContent === currentFilter) {
                    button.className = 'filter-button px-4 py-2 rounded-full font-semibold transition duration-150 ease-in-out text-sm shadow-md bg-indigo-600 text-white hover:bg-indigo-700';
                } else {
                    button.className = 'filter-button px-4 py-2 rounded-full font-semibold transition duration-150 ease-in-out text-sm shadow-md bg-white text-indigo-600 border border-indigo-400 hover:bg-indigo-100';
                }
            });
        };


        // --- 便利な機能 5: 検索サジェスト機能 ---
        const setupSearchSuggest = () => {
            // デバウンスされた入力ハンドラ
            searchInput.addEventListener('input', debounce(handleSuggestInput, 200)); 
            
            // フォーカスが外れたら少し遅れてサジェストを非表示にする（クリックイベントを有効にするため）
            searchInput.addEventListener('blur', () => {
                setTimeout(() => suggestContainer.classList.add('hidden'), 200);
            });
            // フォーカスが当たったとき、クエリがあれば再表示
            searchInput.addEventListener('focus', () => {
                if (searchInput.value.trim().length > 0) {
                    handleSuggestInput();
                }
            });
        };

        const handleSuggestInput = () => {
            const query = searchInput.value.toLowerCase().trim();
            suggestContainer.innerHTML = '';

            if (query.length < 1) {
                suggestContainer.classList.add('hidden');
                return;
            }

            // 名前または分野がクエリにマッチする公式を抽出
            const suggestions = formulaeData.filter(formula => 
                formula.name.toLowerCase().includes(query) || 
                formula.subject.toLowerCase().includes(query) ||
                formula.description.toLowerCase().includes(query)
            ).slice(0, 10); // 最大10件

            if (suggestions.length === 0) {
                suggestContainer.classList.add('hidden');
                return;
            }

            suggestions.forEach(formula => {
                const item = document.createElement('div');
                item.className = 'p-3 cursor-pointer hover:bg-indigo-50 border-b border-gray-100 last:border-b-0 flex justify-between items-center';
                item.innerHTML = `
                    <span class="text-gray-800 font-medium truncate">${formula.name}</span>
                    <span class="text-xs font-medium text-indigo-500 bg-indigo-100 px-2 py-0.5 rounded-full">${formula.subject}</span>
                `;
                item.addEventListener('mousedown', (e) => { 
                    e.preventDefault(); // フォーカス移動を防ぐ
                    searchInput.value = formula.name; // 公式名で検索
                    suggestContainer.classList.add('hidden');
                    searchFormulas();
                });
                suggestContainer.appendChild(item);
            });

            suggestContainer.classList.remove('hidden');
        };


        // --- 検索機能 ---
        const searchFormulas = () => {
            const query = searchInput.value.toLowerCase().trim();
            
            const filteredData = formulaeData.filter(formula => {
                // 1. カテゴリフィルタのチェック
                const categoryMatch = currentFilter === '全て' || formula.subject === currentFilter;

                // 2. 検索キーワードのチェック (名前、分野、説明に含まれているか)
                const queryMatch = !query || 
                    formula.name.toLowerCase().includes(query) ||
                    formula.subject.toLowerCase().includes(query) ||
                    formula.description.toLowerCase().includes(query);
                
                return categoryMatch && queryMatch;
            });

            renderResults(filteredData);
        };

        // --- 結果のレンダリング ---
        const renderResults = (results) => {
            resultsContainer.innerHTML = ''; // 結果をクリア

            if (results.length === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');

                results.forEach((formula, index) => {
                    // ユニークなIDを生成 (計算フォームの切り替えに使用)
                    // formula.name の重複対策のため、indexOfではなく元のformulaeData内でのインデックスを使用
                    const trueIndex = formulaeData.findIndex(f => f.name === formula.name && f.subject === formula.subject);
                    const cardId = `card-${trueIndex}`; 

                    const card = document.createElement('div');
                    card.className = 'formula-card bg-white p-6 rounded-xl border-t-4 border-indigo-500 shadow-md';
                    card.setAttribute('id', cardId);
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">${formula.name}</h2>
                                <span class="text-sm font-medium text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-full">${formula.subject}</span>
                            </div>
                            <!-- 便利な機能 2: コピーボタン -->
                            <button data-formula="${formula.formula}" class="copy-btn text-gray-500 hover:text-indigo-600 p-2 rounded-full bg-gray-100 hover:bg-indigo-50 transition duration-150" aria-label="公式のLaTeXコードをコピー">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 002-2h2a2 2 0 002 2M3 10h18"/>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- 数式表示エリア (MathJaxがレンダリング) -->
                        <div class="formula-display text-center text-2xl py-4 overflow-x-auto">
                            <!-- MathJaxの処理を確実にするため、$$...$$ で囲む -->
                            $$${formula.formula}$$
                        </div>

                        <p class="text-gray-600 text-sm mt-2 pt-3 border-t border-gray-100">${formula.description}</p>
                        
                        ${formula.calculate ? `
                            <button data-card-id="${cardId}" class="calculate-toggle-btn w-full mt-4 py-2 px-4 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600 transition duration-150 shadow-md">
                                計算する
                            </button>
                            <!-- 便利な機能 4: 計算フォームエリア -->
                            <div id="calculator-${cardId}" class="calculator-container mt-4 border-t border-indigo-200">
                                <div class="p-4 bg-indigo-50 rounded-b-lg">
                                    <h3 class="text-lg font-bold text-indigo-700 mb-4">計算フォーム</h3>
                                    <div class="grid grid-cols-2 gap-4" id="input-fields-${cardId}">
                                        <!-- 入力フィールドはJSで生成されます -->
                                    </div>
                                    <button class="calculate-btn mt-4 w-full py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition duration-150 shadow-md" data-card-id="${cardId}">
                                        結果を計算
                                    </button>
                                    <div id="result-output-${cardId}" class="mt-4 p-3 bg-white border border-green-300 rounded-lg text-gray-800 font-mono hidden">
                                        <!-- 結果がここに表示されます -->
                                    </div>
                                    <div id="error-message-${cardId}" class="mt-4 p-3 bg-red-100 border border-red-300 rounded-lg text-red-700 hidden">
                                        <!-- エラーメッセージがここに表示されます -->
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    `;
                    resultsContainer.appendChild(card);
                });

                // MathJaxに新しい要素をレンダリングするよう指示
                if (window.MathJax) {
                    window.MathJax.typesetPromise();
                }
                
                // コピーボタンと計算機能のイベントリスナーを設定
                setupCopyButtons();
                setupCalculatorToggles();
                setupCalculatorButtons();
            }
        };

        // --- 便利な機能 2: クリップボードコピー機能 ---
        const setupCopyButtons = () => {
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const formulaLaTeX = event.currentTarget.getAttribute('data-formula');
                    copyToClipboard(formulaLaTeX);
                    showNotification();
                });
            });
        };

        const copyToClipboard = (text) => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                // document.execCommand('copy') は非推奨だが互換性のため使用
                document.execCommand('copy');
            } catch (err) {
                console.error('クリップボードへのコピーに失敗しました', err);
            }
            document.body.removeChild(textarea);
        };

        // --- 便利な機能 3: コピー成功通知 ---
        const showNotification = () => {
            const notification = document.getElementById('notification');
            notification.classList.remove('opacity-0', 'bg-red-500');
            notification.classList.add('opacity-100', 'bg-green-500');
            
            setTimeout(() => {
                notification.classList.remove('opacity-100');
                notification.classList.add('opacity-0');
            }, 2000);
        };

        // --- 便利な機能 4: 計算機能 (トグルと実行) ---
        const setupCalculatorToggles = () => {
            document.querySelectorAll('.calculate-toggle-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const cardId = event.currentTarget.getAttribute('data-card-id');
                    const container = document.getElementById(`calculator-${cardId}`);
                    // インデックスはカードIDから取得
                    const index = parseInt(cardId.split('-')[1]);
                    const formula = formulaeData[index];

                    container.classList.toggle('active');

                    if (container.classList.contains('active')) {
                        // アクティブになったら入力フィールドを生成
                        generateInputFields(cardId, formula);
                        event.currentTarget.textContent = '計算フォームを閉じる';
                        event.currentTarget.classList.replace('bg-indigo-500', 'bg-gray-500');
                        event.currentTarget.classList.replace('hover:bg-indigo-600', 'hover:bg-gray-600');
                    } else {
                        event.currentTarget.textContent = '計算する';
                        event.currentTarget.classList.replace('bg-gray-500', 'bg-indigo-500');
                        event.currentTarget.classList.replace('hover:bg-gray-600', 'hover:bg-indigo-600');
                    }
                });
            });
        };

        const generateInputFields = (cardId, formula) => {
            const fieldsContainer = document.getElementById(`input-fields-${cardId}`);
            fieldsContainer.innerHTML = '';
            
            formula.variables.forEach(v => {
                const isInput = v.type === 'input' || v.type === 'list-input';
                const colSpan = v.type === 'list-input' ? 'col-span-2' : 'col-span-1';

                const fieldDiv = document.createElement('div');
                fieldDiv.className = colSpan;
                
                if (isInput) {
                    fieldDiv.innerHTML = `
                        <label for="${cardId}-${v.id}" class="block text-sm font-medium text-gray-700 mb-1">
                            ${v.label} ${v.unit ? `(${v.unit.replace('\\Omega', 'Ω')})` : ''}
                        </label>
                        <input type="${v.type === 'list-input' ? 'text' : 'number'}" id="${cardId}-${v.id}" 
                               placeholder="${v.type === 'list-input' ? '例: 10, 20, 30' : '数値を入力'}" 
                               step="${v.type === 'list-input' ? 'any' : 'any'}"
                               class="w-full p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-base">
                    `;
                } else {
                    fieldDiv.innerHTML = `
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ${v.label} ${v.unit ? `(${v.unit.replace('\\Omega', 'Ω')})` : ''}
                        </label>
                        <div class="p-2 bg-white border border-gray-200 rounded-lg text-gray-900 font-bold text-base" id="${cardId}-output-${v.id}">
                            ---
                        </div>
                    `;
                }
                fieldsContainer.appendChild(fieldDiv);
            });
        };

        const setupCalculatorButtons = () => {
            document.querySelectorAll('.calculate-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const cardId = event.currentTarget.getAttribute('data-card-id');
                    const index = parseInt(cardId.split('-')[1]);
                    const formula = formulaeData[index];
                    const inputFields = formula.variables.filter(v => v.type === 'input' || v.type === 'list-input');
                    const outputElement = document.getElementById(`result-output-${cardId}`);
                    const errorElement = document.getElementById(`error-message-${cardId}`);

                    // エラーと結果をリセット
                    outputElement.classList.add('hidden');
                    errorElement.classList.add('hidden');
                    errorElement.textContent = '';
                    outputElement.innerHTML = '';


                    try {
                        // 必要な入力値を取得し、計算関数の引数配列を準備
                        const args = [];
                        let hasEmptyInput = false;

                        for (const v of inputFields) {
                            const inputElement = document.getElementById(`${cardId}-${v.id}`);
                            let value;

                            if (v.type === 'list-input') {
                                // カンマ区切りの文字列として渡す
                                value = inputElement.value.trim();
                                if (value === '') {
                                    hasEmptyInput = true;
                                    break;
                                }
                                args.push(value);
                            } else {
                                // 数値として渡す
                                value = parseFloat(inputElement.value);
                                if (isNaN(value) || inputElement.value.trim() === '') {
                                    hasEmptyInput = true;
                                    break;
                                }
                                args.push(value);
                            }
                        }

                        if (hasEmptyInput) {
                            throw new Error('すべての入力項目に値を入力してください。');
                        }

                        // 計算を実行
                        const results = formula.calculate(...args);

                        // 結果を表示
                        let resultHTML = '<h4 class="font-bold border-b border-gray-200 mb-2 pb-1">計算結果:</h4>';
                        formula.variables.filter(v => v.type === 'output').forEach(v => {
                            const value = results[v.id];
                            // MathJaxの記法を通常の記号に変換
                            const unit = v.unit.replace('\\Omega', 'Ω').replace('\\cdot', '・').replace('\\text{', '').replace('}', '').replace('\\pi', 'π');
                            
                            // 結果を表示エリアに反映
                            const outputDiv = document.getElementById(`${cardId}-output-${v.id}`);
                            if (outputDiv) {
                                outputDiv.textContent = `${value} ${unit}`;
                            }

                            // 結果出力エリアのHTMLを生成
                            resultHTML += `<p class="text-sm">
                                <span class="font-semibold">${v.label}:</span> 
                                <span class="text-green-700">${value}</span> ${unit}
                            </p>`;
                        });

                        outputElement.innerHTML = resultHTML;
                        outputElement.classList.remove('hidden');

                    } catch (error) {
                        console.error('計算エラー:', error);
                        // 計算関数内でのエラーもキャッチして表示
                        errorElement.textContent = `計算エラー: ${error.message}`;
                        errorElement.classList.remove('hidden');
                    }
                });
            });
        };


        // --- 初期化とイベントリスナーの設定 ---
        window.onload = () => {
            generateFilterButtons(); // フィルタボタンを生成
            setupSearchSuggest(); // 検索サジェストを設定
            searchFormulas(); // 初回ロード時に全ての公式を表示

            // Enterキーで検索を実行
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    searchFormulas();
                    suggestContainer.classList.add('hidden'); // サジェストを隠す
                }
            });
        };

    </script>
</body>
</html>
